<html>
    <head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<link rel="shortcut icon" href="favicon/icon.ico">
		
        <title>레그 스트리밍</title>
		<script src="/socket.io/socket.io.js"></script>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">
		<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
		<script src="javascripts/bootstrap-notify.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
		<link rel="stylesheet" type="text/css" href="stylesheets/main.css">
		<script src="javascripts/util.js"></script>
		<script>
			var socket = io( );
			var audio;
			
			var musicPositionElement;
			var elements = [
				title = null,
				artist = null,
				pos = null,
				bg = null,
				bgBuffer = null,
				clientsDesc = null,
				welcomeClientCount = null,
				blurBG = null,
				textContainer = null,
				agreeContainer = null,
				agreeButton = null
			];
			
			
			
			var onLoaded = false;
				
			window.onload = function( )
			{
				elements.title = $( "#musicTitle" );
				elements.artist = $( "#musicArtist" );
				elements.pos = $( "#musicPosition" );
				elements.clientsDesc = $( "#clientsDesc" );
				
				elements.bg = $( "#backgroundCover" );
				elements.bgBuffer = $( "#backgroundBufferCover" );
				elements.agreeContainer = $( "#agreeContainer" );
				elements.agreeButton = $( "#agreeConnectButton" );
				
				elements.bg.css( "backgroundImage", "url( 'images/intro/" + ( Math.floor( Math.random( ) * 7 ) + 1 ) + ".png' )" );
				elements.bgBuffer.css( "backgroundImage", elements.bg.css( "backgroundImage" ) );
				
				elements.blurBG = $( "#blurBackground" );
				elements.textContainer = $( "#mainTextContainer" );
				
				<!-- if (window.Notification) { -->
					<!-- Notification.requestPermission(); -->
				<!-- } -->
				//http://untitledtblog.tistory.com/107 [Untitled]
				
				
				localClientData = {
					name: makeRandomName( )
				}
				
				elements.blurBG.hide( );
				elements.textContainer.hide( );
					
				elements.agreeContainer.css( "opacity", "0" );
				elements.agreeContainer.animate( { opacity: "1" }, 1000 );
				
				elements.agreeButton.on( "click", function( )
				{
					socket.emit( "join", localClientData );
					
					elements.clientsDesc.show( );
					
					$( "#footerTitle" ).css( "animation", "footerTitleFadeOut 1s" );
					$( "#footerTitle" ).animate( { opacity: "0" }, 1000, function( )
					{
						$( "#footerTitle" ).hide( );
					} );
					elements.agreeContainer.css( "animation", "agreeContainerFadeOut 1s" );
					elements.agreeContainer.animate( { opacity: "0" }, 1000, function( )
					{
						elements.agreeContainer.hide( );
					} );
				} );
				
				initializeCanvas( );
				
				groundInitialize( ); // 추후 수정해야함;
				
				onLoaded = true;
			}
			
			function notify(title, text) {
				if (Notification.permission !== 'granted') {
					console.log( "alert false");
					return;
				}
				else {
					var notification = new Notification(title, {
						icon: 'favicon/icon.png',
						body: text,
					});
	 
					notification.onclick = function () {
						
					};
				}
			}
			
			socket.on( "welcome", function( data )
			{
				if ( typeof elements.welcomeClientCount === "undefined" )
					elements.welcomeClientCount = $( "#welcomeClientCount" );
				
				elements.welcomeClientCount.html( data.clientsCount + "명의 사람들이 접속 중입니다." );
			} );
			
			let localClientData = { };
			let anotherClientData = [ ];
			
			// *TODO;
			// under construction;
			socket.on( "clientDataRefresh", function( data )
			{
				switch( data.command )
				{
					case "register":
						anotherClientData.push( data.data );
						break;
					case "update":
						// not working;
						anotherClientData[ data.index ] = data.newData;
						break;
				}
			} );
			
			socket.on( "notification", function( data )
			{
				$.notify( {
						icon: "glyphicon glyphicon-warning-sign",
						title: data.title || "접속 오류 :",
						message: data.message
					},
					{
					allow_dismiss: false,
					type: "warning",
					placement: {
						from: "top",
						align: "center"
					},
					newest_on_top: true,
					animate: {
						enter: "animated fadeInDown",
						exit: "animated fadeOutUp"
					},
					timer: 5000
				} );
			} );
			
			socket.on( "connection_reject", function( data )
			{
				if ( data == true )
				{
					if ( !onLoaded )
					{
						var agreeButtonInterval = setInterval( function( )
						{
							if ( onLoaded )
							{
								elements.agreeButton.off( "click" );
								elements.agreeButton.attr( "disabled", data );
								clearInterval( agreeButtonInterval );
							}
						}, 100 );
					}
					else if ( onLoaded )
					{
						elements.agreeButton.off( "click" );
						elements.agreeButton.attr( "disabled", data );	
					}
				}
			} );
			
			socket.on( "join", function( data ) {
				if ( typeof elements.clientsDesc === "undefined" )
					elements.clientsDesc = $( "#clientsDesc" );
				
				elements.clientsDesc.html( data + "명의 사람들과 같이 듣는 중." );
				
				elements.clientsDesc.css( "opacity", "0" );
				elements.clientsDesc.animate( { opacity: "1" }, 1000 );
			} );
			
			socket.on( "disconnect", function( data )
			{
				$.notify( {
						icon: "glyphicon glyphicon-warning-sign",
						title: "서버 연결 끊김 :",
						message: "서버와의 연결이 끊겼습니다, 죄송합니다."
					},
					{
					allow_dismiss: true,
					type: "danger",
					placement: {
						from: "top",
						align: "center"
					},
					newest_on_top: true,
					animate: {
						enter: "animated fadeInDown",
						exit: "animated fadeOutUp"
					},
					timer: 3000
				} );
			} );
			
			socket.on( "reconnect_attempt", function( attemptNumber )
			{
				$.notify( {
						icon: "glyphicon glyphicon-warning-sign",
						title: "서버 연결 끊김 :",
						message: "다시 접속을 시도합니다 ... (" + attemptNumber + "번 시도됨)"
					},
					{
					allow_dismiss: true,
					type: "warning",
					placement: {
						from: "top",
						align: "center"
					},
					newest_on_top: true,
					animate: {
						enter: "animated fadeInDown",
						exit: "animated fadeOutUp"
					},
					timer: 1000
				} );
			} );
			
			socket.on( "reconnect", function( attemptNumber )
			{
				socket.emit( "join", localClientData );
				
				$.notify( {
						icon: "glyphicon glyphicon-warning-sign",
						title: "서버 연결 완료 :",
						message: "서버에 다시 접속되었습니다."
					},
					{
					allow_dismiss: true,
					type: "success",
					placement: {
						from: "top",
						align: "center"
					},
					newest_on_top: true,
					animate: {
						enter: "animated fadeInDown",
						exit: "animated fadeOutUp"
					},
					timer: 1000
				} );
			} );
			
			socket.on( "music_define", function( data ) {
				if ( typeof audio === "undefined" )
				{
					audio = new Audio( );
					audio.controls = false;
					audio.loop = false;
					audio.autoplay = false;
					audio.preload = "auto";
					audio.pause( );
					audio.volume = 0.5;
					
					if ( typeof elements.pos === "undefined" )
						elements.pos = $( "#musicPosition" );
					
					audio.addEventListener( "timeupdate", function( )
					{
						elements.pos.html( formatTime( audio.currentTime ) + " / " + formatTime( audio.duration ) );
					}, false );
				}
				
				audio.src = data.musicDir;
				audio.currentTime = data.musicPos;
				
				if ( src == null && analyser == null )
				{
					visualizerInitialize( );
				}
				
				if ( !elements.blurBG.is( ":visible" ) )
				{
					elements.blurBG.show( );
					elements.blurBG.css( "opacity", "0" );
					elements.blurBG.animate( { opacity: "1" }, 1000, function( )
					{
						<!-- elements.agreeContainer.hide( ); -->
					} );
				}
					
				if ( !elements.textContainer.is( ":visible" ) )
				{
				
					elements.textContainer.show( );
					elements.textContainer.css( "opacity", "0" );
					elements.textContainer.animate( { opacity: "1" }, 1000, function( )
					{
						<!-- elements.agreeContainer.hide( ); -->
					} );
				}
				
				elements.title.animate( { opacity: "0" }, 1000, function( )
				{
					elements.title.animate( { opacity: "1" }, 1000 );
					
					elements.title.html( data.musicName );
				} );
				
				elements.artist.animate( { opacity: "0" }, 1000, function( )
				{
					elements.artist.animate( { opacity: "1" }, 1000 );
					
					elements.artist.html( data.musicArtist );
				} );
				
				elements.pos.animate( { opacity: "0" }, 1000, function( )
				{
					elements.pos.animate( { opacity: "1" }, 1000 );
				} );
				
				
				
				
				
				
				elements.bgBuffer.css( "backgroundImage", elements.bg.css( "backgroundImage" ) );
				elements.bg.css( "backgroundImage", "url( '" + data.musicCover + "' )" );
				elements.bgBuffer.css( "opacity", "1" );
				elements.bgBuffer.animate( { opacity: "0" }, 500 );
				
				<!-- $( "#bgCover" ).css( "backgroundImage", "url( '" + data.musicCover + "' )" ); -->
				<!-- $( "#bgCover" ).css( "opacity", "0" ); -->
				<!-- $( "#bgCover" ).animate( { opacity: "1" }, 500 ); -->
				
				notify( "음악 재생", data.musicArtist + " - " + data.musicName );
			});
			
			socket.on( "music_changebg", function( data )
			{
				elements.bgBuffer.css( "backgroundImage", elements.bg.css( "backgroundImage" ) );
				elements.bg.css( "backgroundImage", "url( '" + data + "' )" );
				elements.bgBuffer.css( "opacity", "1" );
				elements.bgBuffer.animate( { opacity: "0" }, 500 );
			} );
			
			socket.on( "music_play", function( data ) {
				if ( audio != null )
				{
					audio.play();
				}
			});
			
			socket.on( "music_setpos", function( data ) {
				if ( audio != null )
				{
					audio.currentTime = Number( data );
				}
			});
			
			socket.on( "music_replay", function( data ) {
				if ( audio != null )
				{
					audio.currentTime = 0;
					audio.play();
				}
			});
			
			window.onbeforeunload = function( event )
			{
				<!-- event = event || window.event; -->
				
				<!-- if ( event ) -->
					<!-- event.returnValue = "정말로 나가시겠습니까?"; -->
				
				<!-- return "정말로 나가시겠습니까?"; -->
			};
			
			function makeRandomName(){
				var name = "";
				var possible = "abcdefghijklmnopqrstuvwxyz";
				
				for( var i = 0; i < 10; i++ ) {
					name += possible.charAt(Math.floor(Math.random() * possible.length));
				}
			
				return name;
			}
			
			
			
			function SetVolume( volume )
			{
				audio.volume = volume / 100;
			}
			
				
			
			
			
			
			

			

		</script>
		<script src="javascripts/visualizer.js"></script>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
	</head>
	<body>
		<div id="backgroundCover"></div>
			<div id="backgroundBufferCover"></div>
				<div id="cover">
					<div id="header">
						<font id="mainTitle">ReguStreaming</font>
						<font id="clientsDesc">0명의 사람들과 같이 듣는 중.</font>
					</div>
					
					
					<div id="blurBackground" style="display: none;"></div>
					
					<div id="agreeContainer">
						<img src="images/agree/agreeContainerTop.png" style="position: absolute; left: 50%; margin-left: -256px"></img>
						<p id="agreeContainerTitle">ReguStreaming 에 접속을 환영합니다.</p>
						<p id="welcomeClientCount">0명의 사람들이 접속 중입니다.</p>
						<button type="button" class="btn btn-default" id="agreeConnectButton">접속 (Connect)</button>
					</div>
					
					
					<div id="mainTextContainer" style="display: none;">
						<font id="musicTitle">Music Title</font>
						<font id="musicArtist">Music Artist</font>
						
						<p id="musicPosition">Music Pos / Max</p>
						
						<div class="musicVolumeControlContainer">
							<!-- <img src="images/icon/volume.png" id="musicVolumeControlIcon"></span> -->
							<input id="musicVolumeControl" class="musicVolumeControl" type="range" min="0" max="100" step="1" oninput="SetVolume(this.value)" onchange="SetVolume(this.value)"></input>
						</div>
					</div>
					
					<div id="footer">
						<font id="footerTitle">Copyright 2018. <a href="https://steamcommunity.com/profiles/76561198011675377/" target="_blank">ReguMaster</a> all rights reserved.</font>
					</div>
				
				</div>
				
				<canvas id="canvas" style="position:absolute; top:0%; left:0px; z-index:0"></canvas>
		</div>
	</body>
</html>